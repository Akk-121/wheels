{% extends 'main/base.html' %}
{% load static %}

{% block title %}
    Корзина
{% endblock %}


{% block content %}
<script>
window.onload = function() {
    if(localStorage.getItem('socket')){
        soc = JSON.parse(localStorage.getItem('socket'));
        document.getElementById('len_socket').innerHTML = Object.keys(soc).length;
    }
    else{
       document.getElementById('len_socket').innerHTML = 0;
    }

    let arr = [];
    var summ = 0;

    for (var key in soc) {
        let name = `name${key}`;
        let par = `parametrs${key}`;
        let price = `price${key}`;

        document.getElementById("body").innerHTML += `<div class="alert bg-dark alert-dismissible text-light fade show m-2" role="alert">
            <div class="row">
                <div class="col-lg-4 mt-1" id=${name}>

                </div>

                <div class="col-lg-2 mt-1">
                     <p class="alert-heading" id=${par}></p>
                </div>

                <div class="col-lg-2 mt-1">
                    <p class="alert-heading" id=${price}></p>
                </div>

                <div class="col-md-auto">
                    <button class="btn btn-dark" type="button" onclick="general(${key}, 0);">
                            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" class="bi bi-dash-circle" viewBox="0 0 16 16">
                              <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                              <path d="M4 8a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7A.5.5 0 0 1 4 8z"/>
                            </svg>
                        </button>
                </div>

                <div class="col-lg-auto justify-content-auto mt-1">
                    <div id="result_count${key}"> 1 </div>
                </div>

                <div class="col-sm-auto">
                    <button class="btn btn-dark" type="button" onclick="general(${key}, 1);">
                        <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22"  class="bi bi-plus-circle" viewBox="0 0 16 16">
                          <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                          <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
                        </svg>
                    </button>
                </div>

                <div class="col-sm-auto mt-1">
                    <p class="alert-heading">Итого:</p>
                </div>

                <div class="col-lg-1 mt-1">
                    <div id="result${key}"></div>
                </div>

            </div>
            <div class="row justify-content-auto mb-1">
                <div class="col-sm-3">
                   <p class="alert-heading" id="articul${key}">№</p>
                 </div>
            </div>

            <hr>
            <button onclick="delitions(${key});" class="btn btn-dark btn-sm" style="float: right; margin-top: -20px; margin-right: -25px; width: 0; height: 0" data-bs-dismiss="alert" aria-label="Close">
                <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" class="bi bi-x-circle" viewBox="0 0 16 16">
                  <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                  <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/>
                </svg>
            </button>
        </div>`;

    {#let mass = soc[key];#}
    const mass_all = soc[key];

    document.getElementById(par).innerHTML += mass_all[0] + ' / ' + mass_all[1] + ' R'+ mass_all[2] ;

    const href = `http://127.0.0.1:8000/wheels/${key}`
    document.getElementById(name).innerHTML = `<a class="text-light" href=${href} class="alert-link"><b>` + mass_all[4] + '</b> </a>';

    document.getElementById(price).innerHTML =  mass_all[3] + "(₽/шт.)"

    document.getElementById(`articul${key}`).innerHTML = '№'+ mass_all[5];

    document.getElementById(`result${key}`).innerHTML =  mass_all[3];

    arr[ arr.length ] = key;
    }

    for(let i=0; i<arr.length; i++) {
        var int = parseInt((document.getElementById(`result${arr[i]}`).innerHTML).replaceAll(' ', ''));
        summ = summ + int;
    }
    document.getElementById('summa').innerHTML =  summ.toLocaleString('ru-RU');
    document.getElementById('summa_disable').innerHTML =  summ;
    {##}
    };

function general(ids, x) {
        var who1 = `result${ids.toString()}`;
        var who2 = `price${ids.toString()}`;
        var who3 = `result_count${ids.toString()}`;

        let a = parseInt((document.getElementById(who2).innerHTML).replaceAll(' ', ''));
        let colvo = parseInt((document.getElementById(who3).innerHTML));

        if (isNaN(a) == true) a = 0;
        if (isNaN(colvo) == true) colvo = 0;

        if (x == 1){
            var colvo_itog = colvo + 1;
            var int_summ = parseInt((document.getElementById('summa_disable').innerHTML).replaceAll(' ', ''));
            document.getElementById('summa').innerHTML =  (int_summ + a).toLocaleString('ru-RU');
            document.getElementById('summa_disable').innerHTML =  int_summ + a;
        } else {
            var colvo_itog = colvo - 1;
            if (colvo_itog < 1) {
                colvo_itog = 1
            }
            else{
                var int_summ = parseInt((document.getElementById('summa_disable').innerHTML).replaceAll(' ', ''));
                document.getElementById('summa').innerHTML =  (int_summ - a).toLocaleString('ru-RU');
                document.getElementById('summa_disable').innerHTML =  int_summ - a;
            }

        }

        var c = a * colvo_itog;

        document.getElementById(who1).innerHTML = c.toLocaleString('ru-RU');
        document.getElementById(who3).innerHTML = colvo_itog;
      }

function delitions(ids){
    soc = JSON.parse(localStorage.getItem('socket'));
    delete soc[ids]
    localStorage.setItem('socket', JSON.stringify(soc));

    var int = parseInt((document.getElementById(`price${ids}`).innerHTML).replaceAll(' ', ''));
    var colvo = parseInt((document.getElementById(`result_count${ids}`).innerHTML).replaceAll(' ', ''));
    var int_summ = parseInt((document.getElementById('summa_disable').innerHTML).replaceAll(' ', ''));
    document.getElementById('summa').innerHTML =  (int_summ - (int*colvo)).toLocaleString('ru-RU');
    document.getElementById('summa_disable').innerHTML =  int_summ - (int*colvo);

    var summ = JSON.parse(localStorage.getItem('socket'));
    document.getElementById('len_socket').innerHTML = Object.keys(summ).length;
}

</script>

    <div class="container">
        <div class="alert text-bg-warning fade show" role="alert" id="body">
             <div class="bd-example-snippet row row-cols-6">
                <div class="col">
                    <b><p class="alert-heading">Сумма: </p></b>
                </div>
                <div class="col">
                    <b><p class="alert-heading" id="summa"></p></b>
                </div>
                 <div class="col">
                    <button type="button" class="btn btn-sm btn-success"><h6>Оплатить</h6></button>
                 </div>
                <p style="display: none" id="summa_disable"></p>

            </div>
        </div>
    </div>

{% endblock %}